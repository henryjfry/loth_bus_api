<!DOCTYPE html>
<html>

<head>
    <title>Live Bus Times</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 18px;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            font-size: 24px;
        }
        label, input, button {
            font-size: 18px;
            margin: 10px 0;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 16px;
        }
        input {
            padding: 5px;
            width: 300px;
        }
        button {
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Bus Times</h1>

    <label for="stopId">Bus Stop ID:</label>
    <input type="text" id="stopId" value="36290151">
    <button onclick="getBusTimes()">Fetch Bus Times</button>

    <pre id="output">Loading bus times...</pre>

    <hr>

    <h2>Search for Bus Stops</h2>
    <label for="stopSearch">Stop Name:</label>
    <input type="text" id="stopSearch" placeholder="e.g. Balerno">
    <button onclick="searchStops()">Search Stops</button>

    <pre id="stopResults"></pre>

    <script>
        async function getBusTimes() {
            const stopId = document.getElementById('stopId').value;
            const apiUrl = `http://ws.mybustracker.co.uk/?module=json&function=getBusTimes&key=4d32a91d0e86221c6693f2309a66149d&nb=4&stopId=${stopId}`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();

                let output = '';
                for (const bus of data.busTimes) {
                    output += `ðŸšŒ Service: ${bus.mnemoService} - ${bus.nameService}\nStop: ${bus.stopName}\n\n`;
                    for (const time of bus.timeDatas) {
                        output += `â†’ Destination: ${time.nameDest}\n   Time: ${time.time} (${time.minutes} min)\n\n`;
                    }
                    output += '-----------------------------\n';
                }

                document.getElementById('output').textContent = output;
            } catch (error) {
                document.getElementById('output').textContent = 'Error fetching data: ' + error;
            }
        }

        async function searchStops() {
            const query = document.getElementById('stopSearch').value.toLowerCase();
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent('https://tfe-opendata.com/api/v1/stops')}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();

                const matches = data.stops.filter(stop => stop.name.toLowerCase().includes(query));

                let results = '';
                if (matches.length === 0) {
                    results = 'No matching stops found.';
                } else {
                    for (const stop of matches) {
                        results += `ðŸ›‘ Stop Name: ${stop.name}\nStop ID: ${stop.stop_id}\nDestinations: ${stop.destinations.join(', ')}\nServices: ${stop.services.join(', ')}\n\n`;
                    }
                }

                document.getElementById('stopResults').textContent = results;
            } catch (error) {
                document.getElementById('stopResults').textContent = 'Error fetching stop data: ' + error;
            }
        }

        // Automatically fetch bus times on page load
        window.onload = getBusTimes;
    </script>
</body>
</html>
