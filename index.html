<!DOCTYPE html>
<html>

<head>
    <title>Live Bus Times</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 18px;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            font-size: 24px;
        }
        label, input, button {
            font-size: 18px;
            margin: 10px 0;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 16px;
        }
        input {
            padding: 5px;
            width: 300px;
        }
        button {
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Bus Times</h1>

    <label for="stopId">Bus Stop ID:</label>
    <input type="text" id="stopId" value="36290151">
    <button onclick="getBusTimes()">Fetch Bus Times</button>

    <pre id="output">Loading bus times...</pre>

    <hr>

    <h2>Search for Bus Stops</h2>
    <label for="stopSearch">Stop Name:</label>
    <input type="text" id="stopSearch" placeholder="e.g. Balerno">
    <button onclick="searchStops()">Search Stops</button>

    <pre id="stopResults"></pre>

    <script>
        let defaultStopId = '36290151';

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('stopId')) {
            defaultStopId = urlParams.get('stopId');
        } else {
            const pathParts = window.location.pathname.split('/');
            const lastPart = pathParts[pathParts.length - 1];
            if (/^\d+$/.test(lastPart)) {
                defaultStopId = lastPart;
            }
        }

        document.getElementById('stopId').value = defaultStopId;


async function getBusTimes() {
    const stopId = document.getElementById('stopId').value;
    const apiUrl = `https://tfe-opendata.com/api/v1/live_bus_times/${stopId}`;
    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

    try {
        const response = await fetch(proxyUrl);
        const data = await response.json(); // data is an array

        let output = '';
        const now = new Date();

        for (const bus of data) {
            output += `ðŸšŒ Route: ${bus.routeName}\n\n`;
            for (const dep of bus.departures) {
                const [hours, minutes, seconds] = dep.ineoUTCTime.split(':').map(Number);
                const depTimeLocal = new Date(
                    now.getFullYear(),
                    now.getMonth(),
                    now.getDate(),
                    hours,
                    minutes,
                    seconds
                );

                const diffMs = depTimeLocal - now;
                const diffMin = Math.max(0, Math.round(diffMs / 60000)); // prevent negative values

                output += `â†’ Destination: ${dep.destination}\n   Time: ${dep.ineoUTCTime} (${dep.isLive ? 'Live' : 'Scheduled'}) - ${diffMin} min\n\n`;
            }
            output += '-----------------------------\n';
        }

        document.getElementById('output').textContent = output;
    } catch (error) {
        document.getElementById('output').textContent = 'Error fetching data: ' + error;
    }
}
async function searchStops(initialQuery = null, setTitle = false) {
    const input = document.getElementById('stopSearch');
    const query = (initialQuery ?? input.value).trim().toLowerCase();

    if (!query) {
        document.getElementById('stopResults').textContent = 'Please enter a stop name or ID to search.';
        return;
    }

    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent('https://tfe-opendata.com/api/v1/stops')}`;

    try {
        const response = await fetch(proxyUrl);
        const data = await response.json();

        const matches = data.stops.filter(stop =>
            stop.name.toLowerCase().includes(query) ||
            String(stop.stop_id).toLowerCase().includes(query)
        );

        let results = '';
        if (matches.length === 0) {
            results = 'No matching stops found.';
        } else {
            for (const stop of matches) {
                results += `ðŸ›‘ Stop Name: ${stop.name}\nStop ID: ${stop.stop_id}\nDestinations: ${stop.destinations.join(', ')}\nServices: ${stop.services.join(', ')}\n\n`;
            }

            // Set page title and heading if requested
            if (setTitle) {
                document.title = `Live Bus Times â€“ ${matches[0].name}`;
                const pageTitle = document.querySelector('h1');
                if (pageTitle) {
                    pageTitle.textContent = `Bus Times â€“ ${matches[0].name}`;
                }
            }
        }

        document.getElementById('stopResults').textContent = results;
    } catch (error) {
        document.getElementById('stopResults').textContent = 'Error fetching stop data: ' + error;
    }
}


window.onload = () => {
    getBusTimes();
    searchStops(defaultStopId, true); // true = update titles
};

    </script>
</body>
</html>
